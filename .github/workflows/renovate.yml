name: Renovate
on:
  workflow_dispatch:
  schedule:
    # https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#schedule
    # every 30min between 09:00 and 12:00 on Monday
    - cron: "*/30 13-15 * * 1"
  pull_request:
    branches:
      - main
jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
        with:
          persist-credentials: false

      - uses: actions/create-github-app-token@5d869da34e18e7287c1daad50e0b8ea0f506ce69 # v1.11.0
        id: app-token
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.PRIVATE_KEY }}

      - name: Discover repositories
        env:
          # environment variables used by gh CLI
          # https://cli.github.com/manual/gh_help_environment
          GH_DEBUG: "true"
          GH_PAGER: "cat"
          GH_PROMPT_DISABLED: "true"
          GH_REPO: "${{ github.repository }}"
          # default to automatic actions token
          GH_TOKEN: "${{ steps.app-token.outputs.token }}"
        run: |
          gh repo list --no-archived --json owner,name --jq '.[] | "\(.owner.login)/\(.name)"' > repos.txt
          gh api \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /installation/repositories
          echo "Discovered repositories:"
          cat repos.txt

      # Add discovered repositories to default.json repositories array with jq
      - name: Prepare default.json
        run: |
          jq --rawfile repos repos.txt '.repositories = ($repos | split("\n") | map(select(length > 0)))' default.json > default.json.tmp
          jq '.autodiscover = false' default.json.tmp > default.json
          jq . default.json

      - name: Enable dry-run
        run: echo "RENOVATE_DRY_RUN=full" >> $GITHUB_ENV
        if: github.event_name == 'pull_request'

      - uses: renovatebot/github-action@e1db501385ddcccbaae6fb9c06befae04f379f23 # v40.2.10
        with:
          configurationFile: default.json
          token: ${{ steps.app-token.outputs.token }}
        env:
          LOG_LEVEL: "debug"
          RENOVATE_DRY_RUN: ${{ env.RENOVATE_DRY_RUN }}
